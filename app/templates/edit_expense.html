{% extends "base.html" %}

{% block title %}Edit Expense - Finance Tracker{% endblock %}

{% block content %}
<div class="form-container">
    <div class="glass-card form-card">
        <h1>‚úèÔ∏è Edit Expense</h1>
        
        <form method="POST" enctype="multipart/form-data" class="form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="form-group">
                <label for="description">Description *</label>
                <input type="text" id="description" name="description" value="{{ expense.description }}" required>
            </div>
            
            <div class="form-group">
                <label for="amount">Amount *</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" value="{{ expense.amount }}" required>
            </div>
            
            <div class="form-group">
                <label for="date">Date *</label>
                <input type="date" id="date" name="date" value="{{ expense.date.strftime('%Y-%m-%d') }}" required>
            </div>
            
            <div class="form-group">
                <label for="paid_by">Paid By</label>
                <input type="text" id="paid_by" name="paid_by" value="{{ expense.paid_by or '' }}">
            </div>
            
            <div class="form-group">
                <label for="tags">Tags</label>
                <input type="text" id="tags" name="tags" value="{{ expense.tags or '' }}" placeholder="Type or click tags below">
                
                {% if user_tags %}
                <div class="tag-suggestions">
                    {% for tag in user_tags %}
                    <button type="button" class="tag-btn" data-tag="{{ tag.name }}" style="background: {{ tag.color }}20; border: 1px solid {{ tag.color }}; color: {{ tag.color }};">
                        üè∑Ô∏è {{ tag.name }}
                    </button>
                    {% endfor %}
                </div>
                <small>Click tags to add/remove them. Multiple tags can be separated by commas.</small>
                {% else %}
                <small>No tags yet. <a href="{{ url_for('settings.create_tag') }}" style="color: #a5b4fc;">Create tags in Settings</a></small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="file">Receipt/Invoice</label>
                {% if expense.file_path %}
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                    Current: <a href="{{ url_for('main.download_file', expense_id=expense.id) }}" style="color: #a5b4fc;">Download</a>
                </p>
                {% endif %}
                <input type="file" id="file" name="file" accept="image/*,.pdf">
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('main.view_category', category_id=expense.category_id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>

<style>
.tag-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    margin-bottom: 0.5rem;
}

.tag-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: rgba(255, 255, 255, 0.1);
}

.tag-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.tag-btn.active {
    opacity: 0.6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tagsInput = document.getElementById('tags');
    const tagButtons = document.querySelectorAll('.tag-btn');
    
    // Initialize active states based on existing tags
    const existingTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
    tagButtons.forEach(button => {
        const tagName = button.getAttribute('data-tag');
        if (existingTags.includes(tagName)) {
            button.classList.add('active');
        }
    });
    
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tagName = this.getAttribute('data-tag');
            const currentTags = tagsInput.value;
            const tagsArray = currentTags.split(',').map(t => t.trim()).filter(t => t);
            
            if (tagsArray.includes(tagName)) {
                const newTags = tagsArray.filter(t => t !== tagName);
                tagsInput.value = newTags.join(', ');
                this.classList.remove('active');
            } else {
                if (currentTags.trim()) {
                    tagsInput.value = currentTags.trim() + ', ' + tagName;
                } else {
                    tagsInput.value = tagName;
                }
                this.classList.add('active');
            }
        });
    });
    
    tagsInput.addEventListener('input', function() {
        const tagsArray = this.value.split(',').map(t => t.trim()).filter(t => t);
        tagButtons.forEach(button => {
            const tagName = button.getAttribute('data-tag');
            if (tagsArray.includes(tagName)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    });
});
</script>
{% endblock %}
